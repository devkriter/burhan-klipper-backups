## Macro Overrides
[gcode_macro CANCEL_PRINT]
rename_existing: CANCEL_PRINT_BASE
gcode:
  STATUS_ERROR
  CANCEL_PRINT_BASE

[gcode_macro PAUSE]
rename_existing: PAUSE_BASE
gcode:
  STATUS_PAUSED
  PAUSE_BASE

[gcode_macro RESUME]
rename_existing: RESUME_BASE
gcode:
  STATUS_PRINTING
  RESUME_BASE

##Config
[neopixel status_led]
pin: thb:RGB          # <-- CHANGE to your actual neopixel data pin
chain_count: 1
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0

# --- Internal state for effects + global brightness ---
[gcode_macro _LED_STATE]
# brightness scale: 0.5 = half brightness
variable_brightness: 0.5
# modes: off, ready, heating, paused, error_blink, printing_breathe
variable_mode: "off"
variable_phase: 0
gcode:
  ; (no gcode)

# --- Effect engine (runs repeatedly when enabled) ---
[delayed_gcode _LED_TICK]
gcode:
  {% set st = printer["gcode_macro _LED_STATE"] %}
  {% set b  = st.brightness|float %}
  {% set m  = st.mode|string %}
  {% set p  = st.phase|int %}

  {% if m == "error_blink" %}
    # Blink red: 0.5s on, 0.5s off (tick at 0.25s => toggles every 2 ticks)
    {% set on = ((p // 2) % 2) %}
    {% if on == 1 %}
      SET_LED LED=status_led RED={{1.0*b}} GREEN=0 BLUE=0
    {% else %}
      SET_LED LED=status_led RED=0 GREEN=0 BLUE=0
    {% endif %}
    SET_GCODE_VARIABLE MACRO=_LED_STATE VARIABLE=phase VALUE={{p+1}}
    UPDATE_DELAYED_GCODE ID=_LED_TICK DURATION=0.25

  {% elif m == "printing_breathe" %}
    # Breathing blue (triangle wave): smooth-ish ramp up/down
    # period ~ 2.4s (24 ticks * 0.1s)
    {% set period = 24 %}
    {% set t = (p % period) %}
    {% if t < period/2 %}
      {% set v = (t / (period/2)) %}
    {% else %}
      {% set v = ((period - t) / (period/2)) %}
    {% endif %}
    # keep a small minimum so "off" isn't fully dark while breathing
    {% set v = 0.10 + 0.90 * v %}
    SET_LED LED=status_led RED=0 GREEN=0 BLUE={{v*b}}
    SET_GCODE_VARIABLE MACRO=_LED_STATE VARIABLE=phase VALUE={{p+1}}
    UPDATE_DELAYED_GCODE ID=_LED_TICK DURATION=0.10

  {% else %}
    # any solid mode shouldn't be ticking
    UPDATE_DELAYED_GCODE ID=_LED_TICK DURATION=0
  {% endif %}

## LED Macros
[gcode_macro STATUS_OFF]
gcode:
  SET_LED LED=status_led RED=0 GREEN=0 BLUE=0

[gcode_macro STATUS_READY]
gcode:
  # green
  SET_LED LED=status_led RED=0 GREEN=1 BLUE=0

[gcode_macro STATUS_HEATING]
gcode:
  # orange
  SET_LED LED=status_led RED=1 GREEN=0.35 BLUE=0

[gcode_macro STATUS_PRINTING]
gcode:
  # blue
  SET_LED LED=status_led RED=0 GREEN=0 BLUE=1

[gcode_macro STATUS_PAUSED]
gcode:
  # purple
  SET_LED LED=status_led RED=0.6 GREEN=0 BLUE=0.8

[gcode_macro STATUS_ERROR]
gcode:
  # red
  SET_LED LED=status_led RED=1 GREEN=0 BLUE=0

[delayed_gcode LED_HEATING_BREATHE]
gcode:
  {% set p = printer["gcode_macro _LED_STATE"].phase %}
  {% set v = 0.15 + 0.85 * (0.5 - (0.5 * ( (p % 20) - 10 )|abs / 10.0 )) %}
  SET_LED LED=status_led RED={v} GREEN={v*0.35} BLUE=0
  SET_GCODE_VARIABLE MACRO=_LED_STATE VARIABLE=phase VALUE={p+1}
  UPDATE_DELAYED_GCODE ID=LED_HEATING_BREATHE DURATION=0.15

[gcode_macro _LED_STATE]
variable_phase: 0
gcode:
  ; internal

[gcode_macro LED_HEATING_BREATHE_ON]
gcode:
  SET_GCODE_VARIABLE MACRO=_LED_STATE VARIABLE=phase VALUE=0
  UPDATE_DELAYED_GCODE ID=LED_HEATING_BREATHE DURATION=0.01

[gcode_macro LED_HEATING_BREATHE_OFF]
gcode:
  UPDATE_DELAYED_GCODE ID=LED_HEATING_BREATHE DURATION=0



