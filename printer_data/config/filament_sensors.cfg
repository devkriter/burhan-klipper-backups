## --- Filament Sensors

[filament_switch_sensor PRE_S]
switch_pin: thb:FS_PRE
pause_on_runout: False
runout_gcode: PRE_RUNOUT
insert_gcode: PRE_INSERT

[filament_switch_sensor POST_S]
switch_pin: thb:FS_POST
pause_on_runout: False
runout_gcode: POST_RUNOUT
insert_gcode: POST_INSERT

[gcode_macro _FIL_STATE]
variable_pre_present: 0
variable_post_present: 0
variable_ignore: 0        # set to 1 during intentional load/unload
gcode:
  ; internal


## --- Macros

[gcode_macro PRE_INSERT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=pre_present VALUE=1
  {action_respond_info("PRE_S: filament detected before extruder.")}

[gcode_macro PRE_RUNOUT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=pre_present VALUE=0

  {% if printer.print_stats.state == "printing" %}
    # Pre-sensor empty while printing: spool empty / upstream break
    # Don't pause yet â€” you may still have filament between pre and post.
    {action_respond_info("PRE_S runout during print: spool empty / upstream break. Will pause when POST_S runs out.")}
  {% else %}
    {action_respond_info("PRE_S: filament not present.")}
  {% endif %}

[gcode_macro POST_INSERT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=post_present VALUE=1
  {action_respond_info("POST_S: filament detected after extruder.")}

[gcode_macro POST_RUNOUT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=post_present VALUE=0

  {% if printer.print_stats.state == "printing" %}
    {% set st = printer["gcode_macro _FIL_STATE"] %}

    {% if st.pre_present|int == 0 %}
      {action_respond_info("POST_S runout after PRE_S runout: filament fully exhausted. Pausing for filament change.")}
    {% else %}
      {action_respond_info("POST_S runout while PRE_S still present: likely break after extruder / filament pulled back / severe slip. Pausing.")}
    {% endif %}

    # Optional: set your LED to error blink if you have STATUS_ERROR
    {% if printer["gcode_macro STATUS_ERROR"] is defined %}
      STATUS_ERROR
    {% endif %}

    PAUSE
  {% else %}
    {action_respond_info("POST_S: filament not present.")}
  {% endif %}