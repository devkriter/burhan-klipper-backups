## --- Filament Sensors

[filament_switch_sensor PRE_S]
switch_pin: thb:FS_PRE
pause_on_runout: False
runout_gcode: PRE_RUNOUT
insert_gcode: PRE_INSERT

[filament_switch_sensor POST_S]
switch_pin: thb:FS_POST
pause_on_runout: False
runout_gcode: POST_RUNOUT
insert_gcode: POST_INSERT

## --- Printing auto pause macro
[gcode_macro _FIL_STATE]
variable_pre_present: 0
variable_post_present: 0
gcode:
  ; internal

[gcode_macro PRE_INSERT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=pre_present VALUE=1

[gcode_macro PRE_RUNOUT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=pre_present VALUE=0
  {% if printer.print_stats.state == "printing" %}
    {action_respond_info("PRE_S runout while printing (spool empty / upstream break). Pausing.")}
    {% if printer["gcode_macro STATUS_ERROR"] is defined %}
      STATUS_ERROR
    {% endif %}
    PAUSE
  {% endif %}

[gcode_macro POST_INSERT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=post_present VALUE=1

[gcode_macro POST_RUNOUT]
gcode:
  SET_GCODE_VARIABLE MACRO=_FIL_STATE VARIABLE=post_present VALUE=0
  {% if printer.print_stats.state == "printing" %}
    {action_respond_info("POST_S runout while printing (break/pullback after extruder). Pausing.")}
    {% if printer["gcode_macro STATUS_ERROR"] is defined %}
      STATUS_ERROR
    {% endif %}
    PAUSE
  {% endif %}

## --- Filament load assist macro
[gcode_macro _LOAD_ASSIST]
variable_active: 0
variable_started: 0
# tune these:
variable_step_mm: 0.6        # how much to extrude per tick (mm)
variable_feed_mm_min: 60     # feedrate in mm/min (slow)
gcode:
  ; internal state only

[delayed_gcode _LOAD_ASSIST_TICK]
gcode:
  {% set la = printer["gcode_macro _LOAD_ASSIST"] %}
  {% if la.active|int != 1 %}
    UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0
  {% else %}
    # Safety: never run during an actual print
    {% if printer.print_stats.state == "printing" %}
      SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=active VALUE=0
      SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=started VALUE=0
      UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0
      {action_respond_info("Load-assist stopped (printing started).")}
    {% else %}
      {% set pre  = printer["filament_switch_sensor PRE_S"].filament_detected %}
      {% set post = printer["filament_switch_sensor POST_S"].filament_detected %}

      # If POST sees filament, we're done
      {% if post %}
        SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=active VALUE=0
        SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=started VALUE=0
        UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0
        {action_respond_info("Load-assist complete (POST_S triggered).")}
      {% elif not pre %}
        # Waiting for you to reach PRE_S
        UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0.2
      {% else %}
        # PRE is triggered but POST isn't -> slowly extrude to pull filament through
        {% if not printer.extruder.can_extrude %}
          # Hotend too cold - stop rather than erroring
          SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=active VALUE=0
          SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=started VALUE=0
          UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0
          {action_respond_info("Load-assist stopped: hotend not hot enough to extrude. Heat nozzle and run LOAD_ASSIST again.")}
        {% else %}
          M83
          G1 E{la.step_mm|float} F{la.feed_mm_min|float}
          SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=started VALUE=1
          UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0.2
        {% endif %}
      {% endif %}
    {% endif %}
  {% endif %}

# Start/stop macros
[gcode_macro LOAD_ASSIST]
description: "Enable filament load assist: heats to 170C if needed, then when PRE_S triggers extruder feeds slowly until POST_S triggers."
gcode:
  {% set LOAD_TEMP = 170 %}
  {% if printer.print_stats.state == "printing" %}
    {action_respond_info("LOAD_ASSIST ignored: currently printing.")}
  {% else %}
    {% if printer["gcode_macro STATUS_PRINTING"] is defined %}
      STATUS_PRINTING
    {% endif %}

    {% if printer.extruder.temperature < (LOAD_TEMP - 5) %}
      {action_respond_info("Heating nozzle to " ~ LOAD_TEMP ~ "C for filament loading...")}
      M109 S{LOAD_TEMP}
    {% endif %}

    SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=active VALUE=1
    SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=started VALUE=0
    UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0.01
    {action_respond_info("Load-assist enabled. Insert filament until PRE_S triggers; it will feed until POST_S triggers.")}
  {% endif %}

[gcode_macro LOAD_ASSIST_STOP]
description: "Disable filament load assist."
gcode:
  SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=active VALUE=0
  SET_GCODE_VARIABLE MACRO=_LOAD_ASSIST VARIABLE=started VALUE=0
  UPDATE_DELAYED_GCODE ID=_LOAD_ASSIST_TICK DURATION=0

  {% if printer["gcode_macro STATUS_READY"] is defined %}
    STATUS_READY
  {% endif %}

  {action_respond_info("Load-assist disabled.")}