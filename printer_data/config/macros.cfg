#####################################################################
#   General Macros & Print Handling
#####################################################################
# This file contains the "Working Macros" - the ones you use daily.
# It includes:
# - PRINT_START / PRINT_END (The main print sequence execution)
# - Helper macros like G32 (QGL), PRIME line, and PARK
# - Testing macros (Test Cube)
# - Spoolman integration
#
#####################################################################
#   Print Handling Macros
#####################################################################

# Based on Print Start Macro from Jontek https://github.com/jontek2/A-better-print_start-macro #
# Slicer Starting Gcode:
# 
# SuperSlicer: 
# M104 S0 ; Stops SuperSlicer from sending temp waits separately
# M140 S0
# PRINT_START EXTRUDER=[first_layer_temperature] BED=[first_layer_bed_temperature] CHAMBER=[chamber_temperature]
#
# PrusaSlicer:
# M104 S0 ; Stops PrusaSlicer from sending temp waits separately
# M140 S0
# PRINT_START EXTRUDER=[first_layer_temperature[initial_extruder]] BED=[first_layer_bed_temperature] CHAMBER=[chamber_temperature]
#
# OrcaSlicer:
# M104 S0 ; Stops OrcaSlicer from sending temp waits separately
# M140 S0
# PRINT_START EXTRUDER=[first_layer_temperature] BED=[first_layer_bed_temperature] CHAMBER=[chamber_temperature]

[gcode_macro PRINT_START2]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  {% set target_bed = params.BED|int %}
  {% set target_extruder = params.EXTRUDER|int %}
  {% set target_chamber = params.CHAMBER|default(0)|float %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

##  Uncomment for bed mesh (1 of 3 for bed mesh)
  BED_MESH_CLEAR                                        # Clear old saved bed mesh (if any)
  SET_GCODE_OFFSET Z=0

  SET_DISPLAY_TEXT MSG="Print Starting: Hotend:{target_extruder}c, Bed: {target_bed}c, Chamber: {target_chamber}c" 
# Home the printer, set absolute positioning and update the Stealthburner LEDs.
  #HOME_YXZ
  G28                                                   # Full home (XYZ)
  G0 Z2                                                 # position beacon at 2mm for heat soak
  G90                                                   # Absolute position                                 

  PARK                                                  # Go to center of the bed
  SET_DISPLAY_TEXT MSG="Bed: {target_bed}c"             # Display info on display
# Check if the bed temp is higher than 90c - if so then trigger a heatsoak and toggle filter.
  {% if params.BED|int > 90 %}
    M106 S255                                           # Turn on the part cooling fan
##  Uncomment if you have a filter.
    TOGGLE_FILTER                                      # Turn on the filter
    M140 S{target_bed}                                 # Set the target temp for the bed
##  Uncomment if you have bed fans.
#HEATSOAK_CHAMBER CHAMBER_TEMP={target_chamber} 
  {% endif %}
  M190 S{target_bed}                                   # Set the target temp for the bed

# Heat hotend to 150c. This helps with getting a correct Z-home.
  SET_DISPLAY_TEXT MSG="Hotend: 150c"                  # Display info on display
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM=148 MAXIMUM=152

  SET_DISPLAY_TEXT MSG="Leveling"                      # Display info on display
  G28 Z METHOD=CONTACT CALIBRATE=1
  QUAD_GANTRY_LEVEL                                    # Level the printer via QGL
  ##  Uncomment for bed mesh (2 of 3 for bed mesh)
  BED_MESH_CALIBRATE ADAPTIVE=1                        # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh
  G28 Z METHOD=CONTACT CALIBRATE=0                     ; calibrate z offset only after tilt/mesh
# Heat up the hotend up to target via data from slicer (1c band to get things moveing more easily when overshot)
  SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"
  SMART_PARK
  M107
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={target_extruder}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={target_extruder} MAXIMUM={target_extruder+1}
# set nozzle thermal expansion offset
  {% if printer.configfile.settings.beacon is defined %}
    _BEACON_SET_NOZZLE_TEMP_OFFSET 
  {% endif %}
  #SET_DISPLAY_TEXT MSG="Hotend: {target_extruder}c"     # Display info on display
  #PARK                                                  # Go to center of the bed
  #M107                                                  # Turn off partcooling fan
  #M109 S{target_extruder}                               # Heat the hotend to set temp
  # Get ready to print by doing a primeline and updating the LEDs
  SET_DISPLAY_TEXT MSG="Printer goes brr"               # Display info on display
  #PRIME                                                # Prime nozzle for printing
  G1 E10
  LINE_PURGE

[gcode_macro PRINT_END]
#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
gcode:
  {% set th = printer.toolhead %}
  M400                           ; wait for buffer to clear
  G92 E0                         ; zero the extruder
  G1 E-10.0 F3600                ; retract filament

  G91                            ; relative positioning
  G0 Z1.00 X20.0 Y20.0 F20000    ; move nozzle to remove stringing
# Will retract filament to coldzone to make removing it possible
#  SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
#  TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150 MAXIMUM=152
#  G1 E-10                        ; retract filament to coldzone
  TURN_OFF_HEATERS
  M107                           ; turn off fan
  G1 Z2 F3000                    ; move nozzle up 2mm
  G90                            ; absolute positioning
  G0  X{th.axis_maximum.x//2} Y{th.axis_maximum.y - 10} F3600            ; park nozzle at rear
##  Uncomment for bed mesh (3 of 3 for bed mesh)
  BED_MESH_CLEAR
  SET_SKEW CLEAR=1
# reset nozzle thermal expansion offset
  {% if printer.configfile.settings.beacon is defined %}
    _BEACON_REMOVE_NOZZLE_TEMP_OFFSET
    _BEACON_SET_NOZZLE_TEMP_OFFSET RESET=True
  {% endif %}

  STATUS_READY

  
##  Uncomment if you have a filter.
  UPDATE_DELAYED_GCODE ID=filter_off DURATION=360


#####################################################################
#   General Helper Macros
#####################################################################
[gcode_macro HOME_YXZ]
gcode:
  G90
  G28 Y
  G28 X
  G28 Z

[gcode_macro PARK]
gcode:
    {% set th = printer.toolhead %}
    G0 X{th.axis_maximum.x//2} Y{th.axis_maximum.y//2} Z30  

[gcode_macro G32]
gcode:
    BED_MESH_CLEAR
    G28
    QUAD_GANTRY_LEVEL
    G28
    G0 X87.5 Y90 Z30 F3600
    

[gcode_macro PRIME]
gcode:
  {% set x_mid = printer.toolhead.axis_maximum.x|float / 2 %}
  G0 X{x_mid - 50} Y4 F10000                           # Go to starting point
  G0 Z0.4                                               # Raise Z to 0.4
  G91                                                   # Incremental positioning 
  G1 X100 E20 F1000                                     # Primeline
  G90  


#####################################################################
#   Testing Macros
#####################################################################
[gcode_macro PRINT_TEST_CUBE]
variable_pla_he_temp: 220
variable_pla_bed_temp: 60
variable_abs_he_temp: 265
variable_abs_bed_temp: 110
variable_abs_chamber_temp: 45
gcode:
    RESPOND TYPE=command MSG="action:prompt_begin PRINT TEST CUBE"
    RESPOND TYPE=command MSG="action:prompt_text Which material are you using?"
    RESPOND TYPE=command MSG="action:prompt_button_group_start"
    RESPOND TYPE=command MSG="action:prompt_button ABS|_PRINT_CUBE_START MATERIAL=ABS"
    RESPOND TYPE=command MSG="action:prompt_button PLA|_PRINT_CUBE_START MATERIAL=PLA"
    RESPOND TYPE=command MSG="action:prompt_button_group_end"
    RESPOND TYPE=command MSG="action:prompt_show"


[gcode_macro _PRINT_CUBE_START]
gcode:
      RESPOND TYPE=command MSG="action:prompt_end"
      {% set MATERIAL = params.MATERIAL|default("XXX")|string %}
      RESPOND MSG="Printing Test Cube in {MATERIAL}"
      {% if MATERIAL == "ABS" %}
         {% set EXTRUDER = printer["gcode_macro PRINT_TEST_CUBE"].abs_he_temp%}
         {% set BED = printer["gcode_macro PRINT_TEST_CUBE"].abs_bed_temp%}
      {% elif MATERIAL == "PLA" %}
         {% set EXTRUDER = printer["gcode_macro PRINT_TEST_CUBE"].pla_he_temp%}
         {% set BED = printer["gcode_macro PRINT_TEST_CUBE"].pla_bed_temp%}
         {% set CHAMBER = 0 %}
      {% else %}
      {% endif %}

   PRINT_START EXTRUDER={EXTRUDER} BED={BED} CHAMBER={CHAMBER}
   SDCARD_PRINT_FILE FILENAME=".micron_test_cube.gcode"


#####################################################################
#   Spoolman Macros
#####################################################################
[gcode_macro SET_ACTIVE_SPOOL]
gcode:
  {% if params.ID %}
    {% set id = params.ID|int %}
    {action_call_remote_method(
       "spoolman_set_active_spool",
       spool_id=id
    )}
  {% else %}
    {action_respond_info("Parameter 'ID' is required")}
  {% endif %}

[gcode_macro CLEAR_ACTIVE_SPOOL]
gcode:
  {action_call_remote_method(
    "spoolman_set_active_spool",
    spool_id=None
  )}